# Retrofit 2 + Jspoon = парсинг сайтов "на лету"

![](images/header2.png)

Всем привет! Приходилось ли вам сталкиваться с задачами загрузки каких-либо данных с сайтов, у которых отсутствует API? 
В подобных случаях многие разработчики предпочитают использовать различные вспомогательные библиотеки для обработки html. 
К примеру, одним из наиболее популярных решений для парсинга html является библиотека [Jsoup](jsoup.org), содержащая довольно
мощные инструменты для поиска и извлечения всех необходимых вам данных. Тем не менее, при использовании подобных библиотек 
разработчику все равно потребуется потратить определенное время на "разбор" содержимого сайта и работу с полученными структурами данных. 

Сегодня мы рассмотрим [Jspoon](https://github.com/DroidsOnRoids/jspoon) - небольшую, но довольно полезную библиотеку под Android, которая значительно облегчает этот процесс,
а также попробуем что-нибудь распарсить.

В примере с парсингом подразумевается наличие RxJava 2 и Retrofit 2, которые де-факто являются стандартными инструментами в
арсенале Android-разработчика. 

## Установка

Для установки добавьте необходимые зависимости в файл `app/build.gradle` вашего проекта.

#### Основная библиотека:
~~~ groovy
dependencies {
    implement 'pl.droidsonroids:jspoon:1.2.1'
}
~~~

#### Конвертер для Retrofit 2:
~~~ groovy
dependencies {
    implement 'pl.droidsonroids.retrofit2:converter-jspoon:1.2.1'
}
~~~

## Как это работает?

Работа Jspoon основана на использовании аннотации ***@Selector*** в связке с определенными CSS селекторами для получения POJO объектов.
А благодаря тому, что для внутреннего парсинга html Jspoon использует все тот же Jsoup, селекторы из данной библиотеки
[доступны](https://jsoup.org/cookbook/extracting-data/selector-syntax) для использования с аннотацией ***Selector***.

## @Selector

Аннотация может быть применена к полям следующих типов (или соответствующих им примитивов):
* String
* Boolean
* Integer
* Long
* Float
* Double
* Date
* BigDecimal
* Element (тип данных из Jsoup)
* Любой класс с конструктором по умолчанию
* List и его подтипы

#### Параметры аннотации

##### value
Основной параметр, значение которого будет использоваться в качестве критерия для извлечения данных из html. Поддерживаются все селекторы из Jsoup.

##### attr
Параметр, определяющий извлекаемый из html-тега атрибут. По умолчанию используется значение `textContent`, так же доступны
несколько предопределенных вариантов: `html` (или `innerHtml`) и `outerHtml`. Кроме того, можно указать любой другой атрибут тега,
который нам необходимо извлечь (например, для извлечения ссылки из тега `<img src="...">` необходимо использовать параметр `attr="src"`)

##### format
Если используется для селектора поля типа Date, то определяет используемый формат даты, например:
`@Selector(value = "#date", format = "HH:mm:ss dd.MM.yyyy") Date date;`
В остальных случаях позволяет указать регулярное выражение, которое будет применено к данным, извлеченным основным селектором из параметра ***value***.

##### locale
Locale используется для парсинга типов Float, Double и Date. Вы можете указать свое значение, например `locale = "ru"`.

##### defValue
Если используемый вами селектор не обнаружит подходящих данных, то поле класса будет инициализированно значением по умолчанию, указанным здесь.

## Давайте что-нибудь распарсим!

Перейдем от теории к практике и для примера распарсим раздел [Разработка](https://ru.smedialink.com/blog/razrabotka/) нашего SML-блога.