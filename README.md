# Retrofit 2 + Jspoon = парсинг html на лету

![](images/header2.png)

Всем привет! Приходилось ли вам сталкиваться с задачами загрузки каких-либо данных с сайтов, у которых отсутствует API? 
В подобных случаях многие разработчики предпочитают использовать различные вспомогательные библиотеки для обработки html. 
К примеру, одним из наиболее популярных решений для парсинга html является библиотека [Jsoup](jsoup.org), содержащая довольно
мощные инструменты для поиска и извлечения всех необходимых вам данных. Тем не менее, при использовании подобных библиотек 
разработчику все равно потребуется потратить определенное время на "разбор" содержимого сайта и работу с полученными структурами данных. 

Сегодня мы рассмотрим [Jspoon](https://github.com/DroidsOnRoids/jspoon) - небольшую, но довольно полезную библиотеку, которая значительно облегчает этот процесс,
а также попробуем что-нибудь распарсить.

В примере с парсингом подразумевается наличие RxJava 2 и Retrofit 2, которые де-факто являются стандартными инструментами в
арсенале Android-разработчика.

## Установка

Для установки добавьте необходимые зависимости в файл `app/build.gradle` вашего проекта.

#### Основная библиотека:
~~~ groovy
dependencies {
    implementation 'pl.droidsonroids:jspoon:1.3.0'
}
~~~

#### Конвертер для Retrofit 2:
~~~ groovy
dependencies {
    implementation 'pl.droidsonroids.retrofit2:converter-jspoon:1.3.0'
}
~~~

## Как это работает?

Работа Jspoon основана на использовании аннотации ***@Selector*** с параметрами, на основе которых осуществляется парсинг html для получения
POJO объектов. Благодаря тому, что для внутреннего парсинга html Jspoon использует все тот же Jsoup, для использования с аннотацией ***Selector***
вам [доступен](https://jsoup.org/cookbook/extracting-data/selector-syntax) полный синтаксис селекторов из Jsoup, что позволит извлекать данные из html-кода
практически любой сложности.

## @Selector

Аннотация может быть применена к полям следующих типов (или соответствующих им примитивов):
* String
* Boolean
* Integer
* Long
* Float
* Double
* Date
* BigDecimal
* Element (тип данных из Jsoup)
* Любой класс с конструктором по умолчанию
* List и его подтипы

#### Параметры аннотации Selector

##### value
Основной параметр, значение которого будет использоваться в качестве критерия для извлечения данных из html. Поддерживаются синтаксис селекторов из Jsoup.

##### attr
Параметр, определяющий извлекаемый из html-тега атрибут. По умолчанию используется значение `textContent`, так же доступны
несколько предопределенных вариантов: `html` (или `innerHtml`) и `outerHtml`. Кроме того, можно указать любой другой атрибут тега,
который необходимо извлечь (например, для извлечения ссылки из тега `<img src="...">` необходимо использовать параметр `attr="src"`)

##### regex
Позволяет указать регулярное выражение, которое будет применено к данным, извлекаемым селектором из параметра ***value***.

##### defValue
Если используемый вами селектор не обнаружит подходящих данных, то поле класса будет инициализированно значением по умолчанию, указанным здесь.

## @Format

Дополнительная аннотация для парсинга даты в поле типа Date, используется совместно с аннотацией `@Selector`

#### Параметры аннотации Format

##### value
Определяет формат даты для парсинга, например:
~~~ java
@Format(value = "HH:mm:ss dd.MM.yyyy")
@Selector(value = "#date")
Date date;
~~~

##### languageTag
Locale используется для парсинга типов Float, Double и Date. Вы можете указать свое значение, например:
~~~ java
@Format(languageTag = "ru")
@Selector(value = "div > p > span")
Double pi;
~~~

## Давайте что-нибудь распарсим!

Перейдем от теории к практике и для примера распарсим раздел [Разработка](https://ru.smedialink.com/blog/razrabotka/) нашего SML-блога.